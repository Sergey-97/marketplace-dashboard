<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marketplace Dashboard</title>
  <meta name="description" content="Analytics dashboard for OZON and Wildberries" />
  <meta name="api-base" content="https://marketplace-backend-mnv0.onrender.com/api" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header { color: white; margin-bottom: 30px; }
    header h1 { margin: 0; font-size: 2.5em; font-weight: 700; }
    header p { margin: 8px 0 0 0; opacity: 0.95; font-size: 1.1em; }
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #333;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
    }
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    button:hover { 
      background: #764ba2; 
      transform: translateY(-2px); 
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); 
    }
    button:active { transform: translateY(0); }
    button[disabled] { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none; 
    }
    .status {
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-weight: 600;
      text-align: center;
      display: none;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .status.loading { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }
    .status.success { background: #e8f5e9; color: #388e3c; border-left: 4px solid #388e3c; }
    .status.error { background: #ffebee; color: #d32f2f; border-left: 4px solid #d32f2f; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .metric {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .metric-label { 
      font-size: 13px; 
      opacity: 0.9; 
      margin-bottom: 8px;
      font-weight: 500;
    }
    .metric-value { 
      font-size: 32px; 
      font-weight: bold;
      margin-bottom: 4px;
    }
    .metric-unit { 
      font-size: 12px; 
      opacity: 0.85; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 16px;
      font-size: 14px;
    }
    th, td { 
      padding: 14px 12px; 
      text-align: left; 
      border-bottom: 1px solid #e0e0e0; 
    }
    th { 
      background: #f5f5f5; 
      font-weight: 700;
      color: #333;
    }
    tr:hover { background: #f9f9f9; }
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 15px;
    }
    .error-text { color: #d32f2f; font-size: 13px; margin-top: 4px; }
    h3 { color: #333; margin: 0 0 16px 0; font-size: 1.3em; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>üìä Marketplace Dashboard</h1>
      <p>Analytics for OZON and Wildberries</p>
    </header>

    <!-- Controls -->
    <div class="card">
      <div class="controls">
        <div>
          <label for="startPeriod">üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
          <input id="startPeriod" type="date" value="2024-01-01" />
        </div>
        <div>
          <label for="endPeriod">üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input id="endPeriod" type="date" />
        </div>
        <div>
          <label for="globalChannel">üõí –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</label>
          <select id="globalChannel">
            <option value="all">–í—Å–µ</option>
            <option value="ozon">OZON</option>
            <option value="wildberries">Wildberries</option>
          </select>
        </div>
      </div>
      <div class="button-group">
        <button id="loadData">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button id="syncData">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="syncFull">üì¶ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
      </div>
      <div id="syncStatus" class="status"></div>
    </div>

    <!-- Metrics -->
    <div class="grid" id="metrics"></div>

    <!-- Detailed Tables -->
    <div class="card">
      <h3>üì¶ –ó–∞–∫–∞–∑—ã</h3>
      <div id="ordersTable"><div class="empty-state">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ...</div></div>
    </div>

    <div class="card">
      <h3>üí∞ –†–∞—Å—Ö–æ–¥—ã</h3>
      <div id="expensesTable"><div class="empty-state">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ...</div></div>
    </div>
  </div>

  <script>
    // === API Configuration ===
    const API_BASE = document.querySelector('meta[name="api-base"]')?.getAttribute('content') || 'http://localhost:10000/api';
    console.log('üìç API Base:', API_BASE);

    // === API Functions ===
    async function apiCall(path, options = {}) {
      try {
        const response = await fetch(API_BASE + path, {
          headers: { 'Content-Type': 'application/json', ...options.headers },
          ...options
        });
        
        if (!response.ok) {
          const error = await response.text();
          throw new Error(`HTTP ${response.status}: ${error}`);
        }
        
        return response.json();
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // === UI Helpers ===
    function setStatus(message, type = 'loading') {
      const el = document.getElementById('syncStatus');
      el.textContent = message;
      el.className = `status ${type}`;
      el.style.display = 'block';
    }

    function clearStatus() {
      document.getElementById('syncStatus').style.display = 'none';
    }

    function formatNumber(num) {
      return typeof num === 'number' ? num.toLocaleString('ru-RU') : num;
    }

    function formatCurrency(num) {
      return `‚ÇΩ${formatNumber(Math.round(num))};`
    }

    // === Load Dashboard Data ===
    async function loadDashboardData() {
      const start = document.getElementById('startPeriod').value;
      const end = document.getElementById('endPeriod').value || new Date().toISOString().split('T')[0];
      const marketplace = document.getElementById('globalChannel').value;

      setStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'loading');
      document.getElementById('loadData').disabled = true;

      try {
        const [orders, expenses] = await Promise.all([
          apiCall(`/orders?startDate=${start}&endDate=${end}&marketplace=${marketplace}`),
          apiCall(`/order-expenses?startDate=${start}&endDate=${end}&marketplace=${marketplace}`)
        ]);

        // === Render Metrics ===
        const totalOrders = orders.items?.length || 0;
        const totalRevenue = orders.items?.reduce((sum, o) => sum + (o.price || 0), 0) || 0;
        const totalExpenses = expenses.summary?.totalExpenses || 0;
        const totalProfit = expenses.summary?.totalProfit || 0;

        const metricsHtml = `
          <div class="metric">
            <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            <div class="metric-value">${formatNumber(totalOrders)}</div>
          </div>
          <div class="metric">
            <div class="metric-label">–í—ã—Ä—É—á–∫–∞</div>
            <div class="metric-value">${formatCurrency(totalRevenue)}</div>
          </div>
          <div class="metric">
            <div class="metric-label">–†–∞—Å—Ö–æ–¥—ã</div>
            <div class="metric-value">${formatCurrency(totalExpenses)}</div>
          </div>
          <div class="metric">
            <div class="metric-label">–ü—Ä–∏–±—ã–ª—å</div>
            <div class="metric-value">${formatCurrency(totalProfit)}</div>
          </div>
        `;
        document.getElementById('metrics').innerHTML = metricsHtml;

        // === Render Orders Table ===
        const ordersHtml = orders.items?.length ? `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody>
              ${orders.items.slice(0, 20).map(o => `
                <tr>
                  <td>${o.id || '‚Äî'}</td>
                  <td>${o.order_date ? new Date(o.order_date).toLocaleDateString('ru-RU') : '‚Äî'}</td>
                  <td>${o.marketplace || '‚Äî'}</td>
                  <td>${formatCurrency(o.price || 0)}</td>
                  <td>${o.status || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        document.getElementById('ordersTable').innerHTML = ordersHtml;

        // === Render Expenses Table ===
        const expensesHtml = expenses.items?.length ? `
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>–†–µ–∫–ª–∞–º–∞</th>
                <th>–õ–æ–≥–∏—Å—Ç–∏–∫–∞</th>
                <th>–ö–æ–º–∏—Å—Å–∏—è</th>
                <th>–î–æ—Ö–æ–¥</th>
                <th>–ü—Ä–∏–±—ã–ª—å</th>
              </tr>
            </thead>
            <tbody>
              ${expenses.items.slice(0, 20).map(e => `
                <tr>
                  <td>${e.orderId || '‚Äî'}</td>
                  <td>${formatCurrency(e.adSpend || 0)}</td>
                  <td>${formatCurrency(e.logisticsCost || 0)}</td>
                  <td>${formatCurrency(e.platformFee || 0)}</td>
                  <td>${formatCurrency(e.revenue || 0)}</td>
                  <td style="color: ${(e.profit || 0) >= 0 ? '#388e3c' : '#d32f2f'}">${formatCurrency(e.profit || 0)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        document.getElementById('expensesTable').innerHTML = expensesHtml;

        setStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${totalOrders} –∑–∞–∫–∞–∑–æ–≤`, 'success');
        setTimeout(clearStatus, 4000);
      } catch (error) {
        console.error(error);
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      } finally {
        document.getElementById('loadData').disabled = false;
      }
    }

    // === Trigger Sync ===
    async function triggerSync() {
      const start = document.getElementById('startPeriod').value;
      const end = document.getElementById('endPeriod').value || new Date().toISOString().split('T')[0];
      const marketplace = document.getElementById('globalChannel').value;

      setStatus('‚è≥ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...', 'loading');
      const buttons = ['syncData', 'syncFull', 'loadData'];
      buttons.forEach(id => document.getElementById(id).disabled = true);

      try {
        const promises = [];
        if (marketplace === 'all' || marketplace === 'ozon') {
          promises.push(apiCall('/sync/trigger', { 
            method: 'POST', 
            body: JSON.stringify({ marketplace: 'ozon', startDate: start, endDate: end }) 
          }));
        }
        if (marketplace === 'all' || marketplace === 'wildberries') {
          promises.push(apiCall('/sync/trigger', { 
            method: 'POST', 
            body: JSON.stringify({ marketplace: 'wildberries', startDate: start, endDate: end }) 
          }));
        }
        
        await Promise.all(promises);
        setStatus('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞. –û–±–Ω–æ–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ...', 'success');
        
        setTimeout(() => {
          loadDashboardData();
          clearStatus();
        }, 3000);
      } catch (error) {
        console.error(error);
        setStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
      } finally {
        buttons.forEach(id => document.getElementById(id).disabled = false);
      }
    }

    // === Event Listeners ===
    document.getElementById('loadData').addEventListener('click', loadDashboardData);
    document.getElementById('syncData').addEventListener('click', triggerSync);
    document.getElementById('syncFull').addEventListener('click', triggerSync);

    // === Initialize ===
    document.getElementById('endPeriod').valueAsDate = new Date();
    window.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</body>
</html>
